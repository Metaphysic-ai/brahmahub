# =============================================================================
# PR Checks
# =============================================================================
# Runs on every PR: validates title, applies labels (scope, size, version
# impact), reviews dependencies for vulnerabilities, and flags database
# migrations for careful review.
# =============================================================================

name: PR

on:
  pull_request:
    types: [opened, edited, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # title: enforce conventional commit format on PR titles
  # ---------------------------------------------------------------------------
  title:
    name: PR Title
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate conventional commit format
        uses: amannn/action-semantic-pull-request@48f256284bd46cdaab1048c3721360e808335d50 # v6
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            api
            frontend
            cli
            db
            deploy
          requireScope: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # labels: scope (by files changed), size, and version impact
  # ---------------------------------------------------------------------------
  labels:
    name: Labels
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # Scope labels (api, frontend, cli, database, deploy, ci)
      - name: Scope labels
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6
        with:
          configuration-path: .github/labeler.yml

      # Size labels (size/xs, size/s, size/m, size/l, size/xl)
      - name: Size labels
        uses: codelytv/pr-size-labeler@4ec67706cd878fbc1c8db0a5dcd28b6bb412e85a # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: 'false'

      # Version impact labels (major, minor, patch, no-release)
      - name: Version impact labels
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const allLabels = ['major', 'minor', 'patch', 'no-release'];

            let impact;
            if (/^.+!:/.test(title) || /BREAKING[ -]CHANGE/.test(title)) {
              impact = 'major';
            } else if (/^feat(\(.+\))?:/.test(title)) {
              impact = 'minor';
            } else if (/^(fix|perf)(\(.+\))?:/.test(title)) {
              impact = 'patch';
            } else {
              impact = 'no-release';
            }

            const current = context.payload.pull_request.labels.map(l => l.name);
            const toRemove = allLabels.filter(l => current.includes(l) && l !== impact);

            for (const label of toRemove) {
              try {
                await github.rest.issues.removeLabel({
                  ...context.repo,
                  issue_number: context.payload.pull_request.number,
                  name: label,
                });
              } catch {
                // Label might not exist on repo yet
              }
            }

            if (!current.includes(impact)) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                labels: [impact],
              });
            }

  # ---------------------------------------------------------------------------
  # dependency-review: flag vulnerable or license-incompatible new deps
  # ---------------------------------------------------------------------------
  dependency-review:
    name: Dependency review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Review dependencies
        uses: actions/dependency-review-action@05fe4576374b728f0c523d6a13d64c25081e0803 # v4.8.3
        with:
          fail-on-severity: high
          comment-summary-in-pr: on-failure

  # ---------------------------------------------------------------------------
  # migration: warn when DB migrations are included
  # ---------------------------------------------------------------------------
  migration-warning:
    name: Migration Warning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check for migrations and comment
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              ...context.repo,
              pull_number: context.payload.pull_request.number,
            });

            const migrations = files.filter(f => f.filename.startsWith('db/migrations/'));
            if (migrations.length === 0) return;

            // Don't duplicate the comment
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
            });
            if (comments.some(c => c.body?.includes('Database Migration Detected'))) return;

            const fileList = migrations.map(f => `- \`${f.filename}\` (${f.status})`).join('\n');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: [
                '## Database Migration Detected',
                '',
                'This PR includes migration changes:',
                fileList,
                '',
                'Please verify:',
                '- [ ] Migration is backward-compatible with running code',
                '- [ ] Migration has been tested locally (`mise run migrate`)',
                '- [ ] Rollback path exists or migration is additive-only',
              ].join('\n'),
            });
